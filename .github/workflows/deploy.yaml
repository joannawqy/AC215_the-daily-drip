name: Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ac215-480602
  GAR_LOCATION: gcr.io
  APP_NAME: the-daily-drip-app

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get-tag.outputs.sha_short }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
  
    - name: Debug Secrets 
    # Debug secrets to ensure they are set
      run: echo "GCP_CREDENTIALS is set (length: ${#secrets.GCP_CREDENTIALS})"
      shell: bash

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker

    - name: Get Short SHA
      id: get-tag
      run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Build and Push Docker Image
      env:
        IMAGE_TAG: ${{ steps.get-tag.outputs.sha_short }}
      run: |
        IMAGE_URI="$GAR_LOCATION/$PROJECT_ID/$APP_NAME:$IMAGE_TAG"
        echo "Building $IMAGE_URI..."
        docker build -t $IMAGE_URI -f Dockerfile.monolith .
        docker push $IMAGE_URI
        # Also push latest for convenience
        docker tag $IMAGE_URI "$GAR_LOCATION/$PROJECT_ID/$APP_NAME:latest"
        docker push "$GAR_LOCATION/$PROJECT_ID/$APP_NAME:latest"

  deploy-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Get GKE Credentials
      env:
        GKE_CLUSTER: daily-drip-cluster # TODO: Update this with your actual Cluster Name
        GKE_ZONE: us-central1-a    # TODO: Update this with your actual Zone
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE

    - name: Deploy to GKE
      env:
        IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
      run: |
        IMAGE_URI="$GAR_LOCATION/$PROJECT_ID/$APP_NAME:$IMAGE_TAG"
        echo "Updating deployment to image: $IMAGE_URI"
        
        # Update the deployment image
        kubectl set image deployment/daily-drip-deployment daily-drip=$IMAGE_URI
        
        # Verify deployment
        kubectl rollout status deployment/daily-drip-deployment
