version: "3.9"

x-rag-volumes: &rag-volumes
  - ./dailydrip_rag/data:/app/data
  - ./dailydrip_rag/indexes:/app/indexes

services:
  ingest:
    build:
      context: ./dailydrip_rag
      dockerfile: Dockerfile
    command:
      - rag-ingest
      - --csv
      - data/raw/ucdavis_sample.csv
      - --out
      - data/processed/records.jsonl
    working_dir: /app
    volumes:
      - ./dailydrip_rag/data:/app/data
    restart: "no"

  chunk:
    build:
      context: ./dailydrip_rag
      dockerfile: Dockerfile
    command:
      - rag-chunk
      - --records
      - data/processed/records.jsonl
      - --out
      - data/processed/chunks.jsonl
    working_dir: /app
    depends_on:
      ingest:
        condition: service_completed_successfully
    volumes:
      - ./dailydrip_rag/data:/app/data
    restart: "no"

  index:
    build:
      context: ./dailydrip_rag
      dockerfile: Dockerfile
    command:
      - rag-index
      - --chunks
      - data/processed/chunks.jsonl
      - --persist-dir
      - indexes/chroma
    working_dir: /app
    depends_on:
      chunk:
        condition: service_completed_successfully
    volumes: *rag-volumes
    restart: "no"

  rag:
    build:
      context: ./dailydrip_rag
      dockerfile: Dockerfile
    command:
      - rag-service
    working_dir: /app
    depends_on:
      index:
        condition: service_completed_successfully
    environment:
      RAG_PERSIST_DIR: /app/indexes/chroma
    ports:
      - "8000:8000"
    volumes: *rag-volumes

  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    command:
      - uvicorn
      - agent:app
      - --host
      - 0.0.0.0
      - --port
      - "9000"
    working_dir: /app
    depends_on:
      rag:
        condition: service_started
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RAG_SERVICE_URL: http://rag:8000
    ports:
      - "9000:9000"
